<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Implement JWT with Node.js | Seraphina</title><meta name="keywords" content="Tech,Node.js"><meta name="author" content="Haoyu Wu"><meta name="copyright" content="Haoyu Wu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="As we know, JWT(JSON Web Token) is very useful in the authorization scenario. Here, I will list all steps when I need to get JWT in Node.js.   I Initial preparationsIf you haven’t already, set up the">
<meta property="og:type" content="article">
<meta property="og:title" content="Implement JWT with Node.js">
<meta property="og:url" content="http://sslsl.github.io/2021/02/02/Implement-JWT-with-Node-js/index.html">
<meta property="og:site_name" content="Seraphina">
<meta property="og:description" content="As we know, JWT(JSON Web Token) is very useful in the authorization scenario. Here, I will list all steps when I need to get JWT in Node.js.   I Initial preparationsIf you haven’t already, set up the">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://sslsl.github.io/img/bg/bg8.jpg">
<meta property="article:published_time" content="2021-02-02T20:33:40.000Z">
<meta property="article:modified_time" content="2021-02-02T21:00:55.837Z">
<meta property="article:author" content="Haoyu Wu">
<meta property="article:tag" content="Tech">
<meta property="article:tag" content="Node.js">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://sslsl.github.io/img/bg/bg8.jpg">
<meta property="fb:app_id" content="242214970684617"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://sslsl.github.io/2021/02/02/Implement-JWT-with-Node-js/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-02-02 13:00:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/photo.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">11</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/photo/"><i class="fa-fw fas fa-camera"></i><span> Photo</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/bg/bg8.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Seraphina</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/photo/"><i class="fa-fw fas fa-camera"></i><span> Photo</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movie/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Implement JWT with Node.js</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-02-02T20:33:40.000Z" title="Created 2021-02-02 12:33:40">2021-02-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-02-02T21:00:55.837Z" title="Updated 2021-02-02 13:00:55">2021-02-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Tech/">Tech</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>As we know, JWT(JSON Web Token) is very useful in the authorization scenario. Here, I will list all steps when I need to get JWT in Node.js.  </p>
<h2 id="I-Initial-preparations"><a href="#I-Initial-preparations" class="headerlink" title="I Initial preparations"></a>I Initial preparations</h2><p>If you haven’t already, set up the Node environment for this project. Then, install the following packages that we will be using for this tutorial.</p>
<ul>
<li>Express: The Node.js framework we will be using</li>
<li>Cookie-Parser: Since we will be sending the JWT token in a cookie, use this package to parse the cookie sent along with requests</li>
<li>Body-Parser: This package to parses the body of incoming requests to extract POST parameters<br>Dotenv: This package loads environment variables from .env file to the application environment</li>
<li>Json-Web-Token: This is the package that helps us with the JWT implementation</li>
</ul>
<p>You can install these packages using the following command.<br> <code>npm install express cookie-parser body-parser dotenv json-web-token --save</code></p>
<p>In the next steps, we will implement the functions inside controller.js, which we have used in the above code. We use the login function to handle post requests sent to the /login route and log in users. We use refresh function to handle post requests sent to the /refresh route and issue new access tokens using the refresh token.</p>
<h2 id="II-Set-up-environment-variables"><a href="#II-Set-up-environment-variables" class="headerlink" title="II Set up environment variables"></a>II Set up environment variables</h2><p>Before implementing the logic to log a user in, we need to set up the environment variables that are needed to configure JWTs. Create a .env file and add these two variables that we will be using inside the application.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ACCESS_TOKEN_SECRET&#x3D;swsh23hjddnns</span><br><span class="line">ACCESS_TOKEN_LIFE&#x3D;120</span><br><span class="line">REFRESH_TOKEN_SECRET&#x3D;dhw782wujnd99ahmmakhanjkajikhiwn2n</span><br><span class="line">REFRESH_TOKEN_LIFE&#x3D;86400</span><br></pre></td></tr></table></figure>
<p>You can add any string as the secret. It’s recommended to use a longer secret with random characters as a security measure. The expiration time of an access token we create will be 120 seconds. We also set the secret to signing the refresh token and its expiration time. Note how the refresh token has a longer lifetime compared to the access token.</p>
<h2 id="III-Handle-user-login-and-JWT-token-creation"><a href="#III-Handle-user-login-and-JWT-token-creation" class="headerlink" title="III Handle user login and JWT token creation"></a>III Handle user login and JWT token creation</h2><p>Now we can get to the step of implementing the login function we imported to the app.js file to handle the /login route.<br>We are going to store an array of user objects in the application for the purpose of this implementation. In a real-world scenario, you will be retrieving this user information from a database or any other location. When implementing the login function, first we need to retrieve the username and password sent with the login POST request.<br>If the request doesn’t contain either the username or the password, the server responds with a 401 unauthorized status. The same response applies if the password sent with the request does not match the password stored in the database for that particular username.<br>If the client has sent correct credentials to the server, then we proceed to log in the user to the system by issuing new JWT tokens. In this case, the new logging-in user receives two tokens: access token and refresh token. The access token is then sent along with the response inside a cookie back to the client. The refresh token is stored in the database for issuing access tokens in the future. In our case, we will store the refresh token in the user array we previously created.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const jwt &#x3D; require(&#39;json-web-token&#39;)</span><br><span class="line"></span><br><span class="line">exports.login &#x3D; function(req, res)&#123;</span><br><span class="line"></span><br><span class="line">    let username &#x3D; req.body.username</span><br><span class="line">    let password &#x3D; req.body.password</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;use the payload to store information about the user such as username, user role, etc.</span><br><span class="line">    let payload &#x3D; &#123;username: username&#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;create the access token with the shorter lifespan</span><br><span class="line">    let accessToken &#x3D; jwt.sign(payload, process.env.ACCESS_TOKEN_SECRET, &#123;</span><br><span class="line">        algorithm: &quot;HS256&quot;,</span><br><span class="line">        expiresIn: process.env.ACCESS_TOKEN_LIFE</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;create the refresh token with the longer lifespan</span><br><span class="line">    let refreshToken &#x3D; jwt.sign(payload, process.env.REFRESH_TOKEN_SECRET, &#123;</span><br><span class="line">        algorithm: &quot;HS256&quot;,</span><br><span class="line">        expiresIn: process.env.REFRESH_TOKEN_LIFE</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;store the refresh token in the user array</span><br><span class="line">    users[username].refreshToken &#x3D; refreshToken</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;send the access token to the client inside a cookie</span><br><span class="line">    res.cookie(&quot;jwt&quot;, accessToken, &#123;secure: true, httpOnly: true&#125;)</span><br><span class="line">    res.send()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When sending the access token inside a cookie, remember to set the httpOnly flag to prevent attackers from accessing the cookie from the client-side. We have also set the secure flag in the above example. However, if you are only trying out this code over an HTTP connection, not an HTTPS connection, remove the secure flag to send it with the response.</p>
<h2 id="IV-Add-a-middleware-to-authenticate-user-requests"><a href="#IV-Add-a-middleware-to-authenticate-user-requests" class="headerlink" title="IV Add a middleware to authenticate user requests"></a>IV Add a middleware to authenticate user requests</h2><p>The server needs to check whether a user has logged in before giving access to certain routes. We can use the access token sent in a cookie with every request to verify that the user is, in fact, authenticated. This process is carried out in a middleware.</p>
<p>Let’s create a new file named middleware.js and implement the verify method to check whether the user is authenticated.</p>
<p>First, we should retrieve the access token from the cookie sent with the request. If the request does not contain the access token, it will not proceed to the intended route and instead, return a 403 forbidden error.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const jwt &#x3D; require(&#39;json-web-token&#39;)</span><br><span class="line"></span><br><span class="line">exports.verify &#x3D; function(req, res, next)&#123;</span><br><span class="line">    let accessToken &#x3D; req.cookies.jwt</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;if there is no token stored in cookies, the request is unauthorized</span><br><span class="line">    if (!accessToken)&#123;</span><br><span class="line">        return res.status(403).send()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the request contains the access token, then the server will verify whether it was issued by the server itself using the stored secret. In case the token is expired or recognized as a one not signed by the server, the jsonwebtoken’s verify method will throw an error. We can handle the error to return a 401 error back to the client.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const jwt &#x3D; require(&#39;json-web-token&#39;)</span><br><span class="line"></span><br><span class="line">exports.verify &#x3D; function(req, res, next)&#123;</span><br><span class="line">    let accessToken &#x3D; req.cookies.jwt</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;if there is no token stored in cookies, the request is unauthorized</span><br><span class="line">    if (!accessToken)&#123;</span><br><span class="line">        return res.status(403).send()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let payload</span><br><span class="line">    try&#123;</span><br><span class="line">        &#x2F;&#x2F;use the jwt.verify method to verify the access token</span><br><span class="line">        &#x2F;&#x2F;throws an error if the token has expired or has a invalid signature</span><br><span class="line">        payload &#x3D; jwt.verify(accessToken, process.env.ACCESS_TOKEN_SECRET)</span><br><span class="line">        next()</span><br><span class="line">    &#125;</span><br><span class="line">    catch(e)&#123;</span><br><span class="line">        &#x2F;&#x2F;if an error occured return request unauthorized error</span><br><span class="line">        return res.status(401).send()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now we can use this middleware to protect any route that requires the users to be logged in before accessing. Import the middleware to the place you are handling routes, which, in our case, is app.js. If we are trying to protect a route named /comments, it can be easily achieved by adding the middleware before the route handler.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const &#123;verify&#125; &#x3D; require(&#39;.&#x2F;middleware&#39;)</span><br><span class="line">app.get(&#39;&#x2F;comments&#39;, verify, routeHandler)</span><br></pre></td></tr></table></figure>
<p>The request will be passed on to the route handler only if the user is authenticated.</p>
<h2 id="V-Issuing-new-access-token-using-the-refresh-token"><a href="#V-Issuing-new-access-token-using-the-refresh-token" class="headerlink" title="V Issuing new access token using the refresh token"></a>V Issuing new access token using the refresh token</h2><p>Now we can implement this refresh function to issue new access tokens using the stored refresh token.</p>
<p>The function used here, refresh, is also inside the controller.js file we used before for the login function implementation.</p>
<p>The first part of this function is much like what we did to verify an access token: Check whether the access token was sent and verify the token.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">exports.refresh &#x3D; function (req, res)&#123;</span><br><span class="line"></span><br><span class="line">    let accessToken &#x3D; req.cookies.jwt</span><br><span class="line"></span><br><span class="line">    if (!accessToken)&#123;</span><br><span class="line">        return res.status(403).send()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let payload</span><br><span class="line">    try&#123;</span><br><span class="line">        payload &#x3D; jwt.verify(accessToken, process.env.ACCESS_TOKEN_SECRET)</span><br><span class="line">    &#125;</span><br><span class="line">    catch(e)&#123;</span><br><span class="line">        return res.status(401).send()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then, we are going to retrieve the refresh token of this particular user using the username stored in access token’s payload. Once the refresh token is verified, the server will issue a new access token as implemented in the login function.</p>
<p>If the refresh token is expired or fails to verify, the server will return an unauthorized error. Otherwise, the new access token will be sent in the cookie.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">exports.refresh &#x3D; function (req, res)&#123;</span><br><span class="line"></span><br><span class="line">    let accessToken &#x3D; req.cookies.jwt</span><br><span class="line">    if (!accessToken)&#123;</span><br><span class="line">        return res.status(403).send()</span><br><span class="line">    &#125;</span><br><span class="line">    let payload</span><br><span class="line">    try&#123;</span><br><span class="line">        payload &#x3D; jwt.verify(accessToken, process.env.ACCESS_TOKEN_SECRET)</span><br><span class="line">     &#125;</span><br><span class="line">    catch(e)&#123;</span><br><span class="line">        return res.status(401).send()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;retrieve the refresh token from the users array</span><br><span class="line">    let refreshToken &#x3D; users[payload.username].refreshToken</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;verify the refresh token</span><br><span class="line">    try&#123;</span><br><span class="line">        jwt.verify(refreshToken, process.env.REFRESH_TOKEN_SECRET)</span><br><span class="line">    &#125;</span><br><span class="line">    catch(e)&#123;</span><br><span class="line">        return res.status(401).send()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let newToken &#x3D; jwt.sign(payload, process.env.ACCESS_TOKEN_SECRET, </span><br><span class="line">    &#123;</span><br><span class="line">        algorithm: &quot;HS256&quot;,</span><br><span class="line">        expiresIn: process.env.ACCESS_TOKEN_LIFE</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    res.cookie(&quot;jwt&quot;, newToken, &#123;secure: true, httpOnly: true&#125;)</span><br><span class="line">    res.send()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="VI-Summary"><a href="#VI-Summary" class="headerlink" title="VI Summary"></a>VI Summary</h2><p>In this artical, I wrote the steps of implementing authentication with JWT in Node.js. As a continuation of our previous post, where we discussed the theories behind JWT authentication, our implementation was focused on adhering to the best practices we discussed before. As a result, our JWT implementation made use of cookies to send JWTs and refresh tokens to generate new access tokens. If you are willing to take a step ahead of this implementation, you can come up with a solution to re-issue refresh tokens within a short timespan to avoid security breaches.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Haoyu Wu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://sslsl.github.io/2021/02/02/Implement-JWT-with-Node-js/">http://sslsl.github.io/2021/02/02/Implement-JWT-with-Node-js/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Tech/">Tech</a><a class="post-meta__tags" href="/tags/Node-js/">Node.js</a></div><div class="post_share"><div class="social-share" data-image="/img/bg/bg8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/02/02/Python-Django-Shopping-Website/"><img class="prev-cover" src="/img/bg/bg1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Python-Django Shopping Website</div></div></a></div><div class="next-post pull-right"><a href="/2021/01/31/Content-based-Image-Retrieved-System-II/"><img class="next-cover" src="/img/bg/bg4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Content-based Image Retrieved System II</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/01/28/My-internship/" title="My internship"><img class="cover" src="/img/QB-online-logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-28</div><div class="title">My internship</div></div></a></div><div><a href="/2021/01/29/FIRST-NOTE-Build-my-own-PriorityQueue/" title="FIRST NOTE: Build my own PriorityQueue"><img class="cover" src="/img/bg/bg10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-29</div><div class="title">FIRST NOTE: Build my own PriorityQueue</div></div></a></div><div><a href="/2021/02/02/Python-Django-Shopping-Website/" title="Python-Django Shopping Website"><img class="cover" src="/img/bg/bg1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-02</div><div class="title">Python-Django Shopping Website</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Disqus</span><span class="switch-btn"></span><span class="second-comment">Valine</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/photo.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Haoyu Wu</div><div class="author-info__description">A Secret Garden</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">11</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sslsl"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://gitlab.com/oliviawhy" target="_blank" title="Gitlab"><i class="fab fa-gitlab"></i></a><a class="social-icon" href="mailto:seraphinawu233@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://www.instagram.com/haoyubb233/" target="_blank" title="Instagram"><i class="fab fa-instagram-square"></i></a><a class="social-icon" href="https://www.linkedin.com/in/haoyu-wu-5b3019192/" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog. Come to discover something interesting~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#I-Initial-preparations"><span class="toc-number">1.</span> <span class="toc-text">I Initial preparations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#II-Set-up-environment-variables"><span class="toc-number">2.</span> <span class="toc-text">II Set up environment variables</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#III-Handle-user-login-and-JWT-token-creation"><span class="toc-number">3.</span> <span class="toc-text">III Handle user login and JWT token creation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IV-Add-a-middleware-to-authenticate-user-requests"><span class="toc-number">4.</span> <span class="toc-text">IV Add a middleware to authenticate user requests</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V-Issuing-new-access-token-using-the-refresh-token"><span class="toc-number">5.</span> <span class="toc-text">V Issuing new access token using the refresh token</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VI-Summary"><span class="toc-number">6.</span> <span class="toc-text">VI Summary</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/02/22/C-Interview-Questions/" title="C++ Interview Questions"><img src="/img/bg/bg4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C++ Interview Questions"/></a><div class="content"><a class="title" href="/2021/02/22/C-Interview-Questions/" title="C++ Interview Questions">C++ Interview Questions</a><time datetime="2021-02-22T17:42:33.000Z" title="Created 2021-02-22 09:42:33">2021-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/16/Data-Network-Research-3-Dimension-Poisson-Point-Process-Connection/" title="Data Network Research--3 Dimension Poisson Point Process Connection"><img src="/img/bg/bg10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Data Network Research--3 Dimension Poisson Point Process Connection"/></a><div class="content"><a class="title" href="/2021/02/16/Data-Network-Research-3-Dimension-Poisson-Point-Process-Connection/" title="Data Network Research--3 Dimension Poisson Point Process Connection">Data Network Research--3 Dimension Poisson Point Process Connection</a><time datetime="2021-02-16T21:18:10.000Z" title="Created 2021-02-16 13:18:10">2021-02-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/10/Socket-Programming/" title="Socket Programming"><img src="/img/bg/bg6.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Socket Programming"/></a><div class="content"><a class="title" href="/2021/02/10/Socket-Programming/" title="Socket Programming">Socket Programming</a><time datetime="2021-02-10T21:58:04.000Z" title="Created 2021-02-10 13:58:04">2021-02-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/10/Bitwise-Operators/" title="Bitwise Operators"><img src="/img/bg/bg7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Bitwise Operators"/></a><div class="content"><a class="title" href="/2021/02/10/Bitwise-Operators/" title="Bitwise Operators">Bitwise Operators</a><time datetime="2021-02-10T16:18:22.000Z" title="Created 2021-02-10 08:18:22">2021-02-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/02/02/Python-Django-Shopping-Website/" title="Python-Django Shopping Website"><img src="/img/bg/bg1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python-Django Shopping Website"/></a><div class="content"><a class="title" href="/2021/02/02/Python-Django-Shopping-Website/" title="Python-Django Shopping Website">Python-Django Shopping Website</a><time datetime="2021-02-02T21:23:24.000Z" title="Created 2021-02-02 13:23:24">2021-02-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Haoyu Wu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'http://sslsl.github.io/2021/02/02/Implement-JWT-with-Node-js/'
    this.page.identifier = '2021/02/02/Implement-JWT-with-Node-js/'
    this.page.title = 'Implement JWT with Node.js'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://sslsl-github-io.disqus.com/embed.js';

      //s.src = 'https://sslsl-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'brwybltITbYMbzshh6ugFhfb-gzGzoHsz',
      appKey: 'lM8dFGuhc9XojNyPYk9I0441',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Disqus' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="aplayer no-destroy" data-id="2539099971" data-server="netease" data-type="playlist" data-fixed="true" data-listmaxheight="340px" data-mini="true" data-listFolded="true" data-order="random" data-preload="auto" data-lrctype=0 data-autoplay="false" data-mutex="true" muted></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})</script></div></body></html>